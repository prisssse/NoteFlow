ä¸‹é¢æ˜¯ä¸€ä»½å¯ä»¥ç›´æ¥ä¸¢ç»™ Codex å½“â€œæ–½å·¥å›¾â€çš„å®Œæ•´è§„åˆ’ä¹¦ï¼ˆMVP å¯ä¸€æ¬¡æ€§å†™å®Œï¼‰ã€‚æˆ‘æŠŠèŒƒå›´æ”¶å¾—å¾ˆçª„ï¼š**ä¸“æ³¨â€œéŸ³é«˜è¯†è°± + å¯¹åº”ç´é”®â€**ï¼Œä¸åšå¤æ‚èŠ‚å¥ä¸å’Œå£°ï¼Œè¿™æ ·å®ç°ç®€å•ã€ä½“éªŒæ¸…æ™°ã€ä»£ç å¯æ§ã€‚

---

## 1. é¡¹ç›®åç§°ä¸ä¸€å¥è¯å®šä½

**SightKeyï¼ˆæš‚å®šï¼‰**
ä¸€ä¸ªä¸“é—¨ç»ƒä¹ é’¢ç´è¯†è°±çš„è½»é‡ Appï¼šå±å¹•ä¸Šæ˜¾ç¤ºäº”çº¿è°±å•éŸ³ç¬¦ï¼Œç”¨æˆ·åœ¨**å¯è§†åŒ– 88 é”®é’¢ç´é”®ç›˜**ï¼ˆè§¦å±/é¼ æ ‡ï¼‰æˆ–**å¤–æ¥ MIDI é”®ç›˜**ä¸ŠæŒ‰ä¸‹å¯¹åº”é”®ï¼Œå®æ—¶åˆ¤å®šå¯¹é”™å¹¶è®°å½•è¿›æ­¥ã€‚

---

## 2. ç›®æ ‡ä¸éç›®æ ‡

### 2.1 ç›®æ ‡ï¼ˆMVPï¼‰

1. **è¯†è°±åˆ°ç´é”®çš„æ˜ å°„è®­ç»ƒ**ï¼šçœ‹åˆ°éŸ³ç¬¦ â†’ æ‰¾åˆ°å¯¹åº”é”® â†’ æŒ‰ä¸‹ã€‚
2. è®­ç»ƒå¯é…ç½®ï¼šé«˜éŸ³è°±å·/ä½éŸ³è°±å·ã€éŸ³åŸŸèŒƒå›´ã€æ˜¯å¦åŒ…å«å‡é™å·ã€é¢˜é‡ã€‚
3. å®æ—¶åé¦ˆï¼šæŒ‰é”™æç¤ºã€æŒ‰å¯¹è‡ªåŠ¨ä¸‹ä¸€é¢˜ã€ç»Ÿè®¡æ­£ç¡®ç‡/ååº”æ—¶é—´ã€‚
4. **é”®ç›˜å¯è§†åŒ–**ï¼šæ­£ç¡®/é”™è¯¯é”®é«˜äº®ï¼Œæ”¯æŒæ˜¾ç¤ºéŸ³åï¼ˆå¯å¼€å…³ï¼‰ã€‚
5. å¯ç¦»çº¿ä½¿ç”¨ï¼ˆPWA + æœ¬åœ°å­˜å‚¨ï¼‰ã€‚

### 2.2 éç›®æ ‡ï¼ˆå…ˆä¸åšï¼‰

* å¤æ‚èŠ‚å¥ï¼ˆå…«åˆ†éŸ³ç¬¦ã€è¿éŸ³ã€åˆ‡åˆ†ã€æ‹å·ï¼‰
* è§†å¥æ•´æ®µè°±å­è‡ªåŠ¨æ»šåŠ¨
* å½•éŸ³éº¦å…‹é£è¯†åˆ«ï¼ˆéŸ³é«˜æ£€æµ‹ä¼šæ˜¾è‘—å¢åŠ éš¾åº¦å’Œè¯¯å·®ï¼‰
* ç™»å½•ã€äº‘åŒæ­¥ã€æ’è¡Œæ¦œï¼ˆå¯åç»­åŠ ï¼‰

---

## 3. ç”¨æˆ·æ•…äº‹ï¼ˆUser Storiesï¼‰

1. ä½œä¸ºåˆå­¦è€…ï¼Œæˆ‘æƒ³é€‰æ‹©â€œé«˜éŸ³è°±å· + åªç»ƒç™½é”®â€ï¼Œå¿«é€Ÿå»ºç«‹ä½ç½®æ„Ÿã€‚
2. ä½œä¸ºè¿›é˜¶è€…ï¼Œæˆ‘æƒ³æ‰“å¼€â€œå‡é™å·â€ï¼Œç»ƒåŠéŸ³è¯†åˆ«ä¸é»‘é”®å®šä½ã€‚
3. ä½œä¸ºç»ƒä¹ è€…ï¼Œæˆ‘æƒ³æ¯æ¬¡ç»ƒ 5 åˆ†é’Ÿï¼Œçœ‹å‡†ç¡®ç‡ä¸å¹³å‡ååº”æ—¶é—´ã€‚
4. ä½œä¸ºæœ‰ç”µå­ç´çš„äººï¼Œæˆ‘æƒ³ç›´æ¥ç”¨ **MIDI é”®ç›˜**å¼¹ä¸€ä¸‹å°±åˆ¤å®šå¯¹é”™ã€‚

---

## 4. MVP åŠŸèƒ½æ¸…å•ï¼ˆéªŒæ”¶æ ‡å‡†æ˜ç¡®ï¼‰

### 4.1 é¡µé¢ç»“æ„

* **é¦–é¡µ Home**

  * å¼€å§‹ç»ƒä¹ 
  * ç»ƒä¹ è®¾ç½®å…¥å£
  * æœ€è¿‘ä¸€æ¬¡æˆç»©æ‘˜è¦
* **è®¾ç½® Settings**

  * è°±å·ï¼šé«˜éŸ³ / ä½éŸ³ / æ··åˆï¼ˆMVP å¯å…ˆåšé«˜éŸ³+ä½éŸ³ï¼Œæ··åˆå¯é€‰åšï¼‰
  * éŸ³åŸŸï¼šèµ·å§‹é”®åˆ°ç»“æŸé”®ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼Œå¦‚ C3 åˆ° C5ï¼‰
  * å‡é™å·ï¼šå…³é—­ / å¼€å¯ï¼ˆå¼€å¯åéšæœºå‡ºç° # æˆ– bï¼‰
  * æ˜¾ç¤ºéŸ³åï¼šå¼€/å…³ï¼ˆé”®ç›˜é”®ä¸Šæ˜¾ç¤º C D Eâ€¦ï¼‰
  * è¾“å…¥æ–¹å¼ï¼šå±å¹•é”®ç›˜ / MIDIï¼ˆè‡ªåŠ¨æ£€æµ‹æ”¯æŒä¸å¦ï¼‰
  * æ¯ç»„é¢˜æ•°ï¼š10/20/30ï¼ˆé»˜è®¤ 20ï¼‰
* **ç»ƒä¹  Practice**

  * äº”çº¿è°±åŒºåŸŸï¼šå±•ç¤ºå•ä¸ªéŸ³ç¬¦ï¼ˆç»Ÿä¸€ç”¨å››åˆ†éŸ³ç¬¦ç¬¦å¤´å³å¯ï¼‰
  * é”®ç›˜åŒºåŸŸï¼š88 é”®å¯ç¼©æ”¾æ˜¾ç¤ºï¼ˆç§»åŠ¨ç«¯æ¨ªå‘å¯æ»šåŠ¨ï¼‰
  * é¡¶éƒ¨ä¿¡æ¯ï¼šé¢˜å·ã€è¿å¯¹ streakã€ç”¨æ—¶
  * åé¦ˆï¼šå¯¹äº†ç»¿è‰²é—ªä¸€ä¸‹å¹¶è‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼›é”™äº†çº¢è‰²é«˜äº®é”™è¯¯é”®å¹¶å…è®¸é‡è¯•
* **ç»“ç®— Results**

  * æ­£ç¡®ç‡ã€å¹³å‡ååº”æ—¶é—´ã€æœ€å¤§è¿å¯¹
  * é‡æ–°å¼€å§‹ã€è¿”å›é¦–é¡µ

### 4.2 åˆ¤å®šè§„åˆ™ï¼ˆMVPï¼‰

* æ¯é¢˜åªæœ‰ä¸€ä¸ªç›®æ ‡éŸ³ï¼ˆå«å‡é™å·æ—¶ä¹Ÿåªæœ‰ä¸€ä¸ªå…·ä½“éŸ³é«˜ï¼‰ã€‚
* ç”¨æˆ·æŒ‰ä¸‹ä¸€ä¸ªé”®ï¼ˆç‚¹å‡»æˆ– MIDI note onï¼‰ï¼š

  * è‹¥ MIDI å·ç›¸åŒ â†’ æ­£ç¡®
  * å¦åˆ™ â†’ é”™è¯¯ï¼ˆè®°å½•ä¸€æ¬¡é”™è¯¯ï¼Œä½†æœ¬é¢˜å¯ç»§ç»­ç›´åˆ°ç­”å¯¹ï¼Œæˆ–è®¾ç½®å…è®¸è·³è¿‡ï¼‰
* ååº”æ—¶é—´ï¼šä»é¢˜ç›®å‡ºç°åˆ°ç¬¬ä¸€æ¬¡æŒ‰é”®ï¼ˆå¯é€‰ï¼šåˆ°ç­”å¯¹ä¸ºæ­¢ï¼ŒMVP ç”¨â€œé¦–æ¬¡æŒ‰é”®â€æ›´ç®€å•ï¼‰

---

## 5. æŠ€æœ¯é€‰å‹ï¼ˆå°½é‡ç®€å•ä½†å¤Ÿç”¨ï¼‰

### 5.1 æ¨èæŠ€æœ¯æ ˆï¼ˆæœ€çœäº‹çš„ä¸€å¥—ï¼‰

* **å‰ç«¯**ï¼šReact + TypeScript + Vite
* **äº”çº¿è°±æ¸²æŸ“**ï¼šVexFlowï¼ˆæµè§ˆå™¨ç«¯æˆç†Ÿã€æ–‡æ¡£å¤šã€æ— éœ€åç«¯ï¼‰
* **çŠ¶æ€ç®¡ç†**ï¼šZustandï¼ˆè½»é‡ï¼‰
* **æ ·å¼**ï¼šTailwind CSSï¼ˆå¿«é€Ÿæ­ç•Œé¢ï¼‰
* **æµ‹è¯•**ï¼šVitest + React Testing Library
* **PWA**ï¼švite-plugin-pwaï¼ˆç¦»çº¿ç¼“å­˜ã€å¯å®‰è£…åˆ°æ¡Œé¢/æ‰‹æœºï¼‰
* **æœ¬åœ°å­˜å‚¨**ï¼šlocalStorageï¼ˆMVP è¶³å¤Ÿï¼›ç»Ÿè®¡æ•°æ®é‡å¾ˆå°ï¼‰

### 5.2 MIDI æ”¯æŒ

* **Web MIDI API**ï¼ˆChrome/Edge æ¡Œé¢æ”¯æŒè¾ƒå¥½ï¼›ç§»åŠ¨ç«¯å…¼å®¹ä¸ä¸€ï¼‰
* åšæ³•ï¼šæ£€æµ‹ `navigator.requestMIDIAccess` æ˜¯å¦å­˜åœ¨

  * å­˜åœ¨åˆ™å¯å¯ç”¨ MIDI è¾“å…¥
  * ä¸å­˜åœ¨å°±éšè— MIDI é€‰é¡¹ï¼Œä»…ç”¨å±å¹•é”®ç›˜

> è¿™æ ·ä½ èƒ½è·å¾—â€œå¯¹åº”ç´é”®â€çš„çœŸå®ä½“éªŒï¼ŒåŒæ—¶ä¿æŒä»£ç é‡å¯æ§ã€‚

---

## 6. å…¼å®¹æ€§è¦æ±‚

* æ¡Œé¢ Chrome/Edgeï¼šå®Œæ•´æ”¯æŒï¼ˆå« MIDIï¼‰
* æ¡Œé¢ Firefoxï¼šéƒ¨åˆ†ä¸æ”¯æŒ Web MIDIï¼ˆçœ‹ç‰ˆæœ¬ä¸é…ç½®ï¼‰ï¼Œè‡ªåŠ¨é™çº§åˆ°å±å¹•é”®ç›˜
* iOS Safariï¼šå¤§æ¦‚ç‡æ—  Web MIDIï¼Œä»å¯å±å¹•é”®ç›˜ç»ƒä¹ 
* Android Chromeï¼šå±å¹•é”®ç›˜ OKï¼ŒMIDI è§†è®¾å¤‡è€Œå®šï¼ˆé™çº§ç­–ç•¥åŒä¸Šï¼‰

---

## 7. é¢†åŸŸæ¨¡å‹ä¸æ•°æ®ç»“æ„

### 7.1 éŸ³ç¬¦æ¨¡å‹ï¼ˆæ ¸å¿ƒï¼‰

ç”¨â€œç»å¯¹éŸ³é«˜â€ç»Ÿä¸€ï¼š**MIDI note number**ï¼ˆæœ€çœå¿ƒï¼‰ã€‚

```ts
// A0 = 21, C8 = 108ï¼ˆ88é”®é’¢ç´èŒƒå›´ï¼‰
export type MidiNote = number;

export type Clef = "treble" | "bass";
export type AccidentalMode = "off" | "on";

export interface PracticeConfig {
  clef: Clef;                 // MVP: treble/bass
  rangeMin: MidiNote;         // default: treble E4(64)~C6(84), bass G2(43)~E4(64)
  rangeMax: MidiNote;
  accidentalMode: AccidentalMode;
  showNoteNamesOnKeys: boolean;
  questionsPerSession: number; // default: 20
  inputMode: "screen" | "midi"; // è‡ªåŠ¨æ£€æµ‹ midi å¯ç”¨æ€§åå…è®¸é€‰æ‹©
}

export interface Question {
  id: string;
  targetMidi: MidiNote;
  clef: Clef;
  // ä¾›æ¸²æŸ“ä½¿ç”¨ï¼ˆç”± targetMidi è½¬æ¢å¾—åˆ°ï¼‰
  vexflowKey: string; // e.g. "c#/4"
}

export interface Attempt {
  questionId: string;
  firstInputAtMs: number; // epoch ms
  inputs: Array<{ midi: MidiNote; atMs: number; correct: boolean }>;
  resolvedAtMs?: number;  // ç­”å¯¹æ—¶é—´
}

export interface SessionResult {
  sessionId: string;
  startedAtMs: number;
  endedAtMs: number;
  config: PracticeConfig;
  questions: Question[];
  attempts: Attempt[];
  summary: {
    accuracyByFirstTry: number; // é¦–æ¬¡å°±å¯¹çš„æ¯”ä¾‹
    avgReactionMs: number;      // é¦–æ¬¡æŒ‰é”®ååº”æ—¶é—´å¹³å‡
    maxStreak: number;
  };
}
```

### 7.2 æœ¬åœ°å­˜å‚¨é”®

* `sk_config_v1`ï¼šPracticeConfig
* `sk_last_result_v1`ï¼šSessionResultï¼ˆä»…æœ€è¿‘ä¸€æ¬¡ï¼‰
* `sk_history_v1`ï¼šSessionResult[]ï¼ˆå¯é€‰ï¼Œæœ€å¤šä¿ç•™ 50 æ¡ï¼‰

---

## 8. æ ¸å¿ƒç®—æ³•ä¸å®ç°ç»†èŠ‚

### 8.1 MIDI å·ä¸ 88 é”®ç´¢å¼•

* 88 é”®èŒƒå›´ï¼šMIDI 21(A0) åˆ° 108(C8)
* é”®ç›˜ç»„ä»¶å†…éƒ¨ç´¢å¼•ï¼š0..87

```ts
export const PIANO_MIN = 21;
export const PIANO_MAX = 108;

export function midiToKeyIndex(midi: number): number {
  return midi - PIANO_MIN;
}
export function keyIndexToMidi(i: number): number {
  return i + PIANO_MIN;
}
```

### 8.2 åˆ¤æ–­é»‘é”®/ç™½é”®

ç”¨ 12 å¹³å‡å¾‹çš„éŸ³çº§åˆ¤æ–­ï¼š

```ts
// 0=C,1=C#,2=D,3=D#,4=E,5=F,6=F#,7=G,8=G#,9=A,10=A#,11=B
const BLACK_PCS = new Set([1, 3, 6, 8, 10]);

export function isBlackKey(midi: number): boolean {
  const pc = midi % 12;
  return BLACK_PCS.has(pc);
}
```

### 8.3 ç”Ÿæˆéšæœºé¢˜ç›®ï¼ˆå¸¦çº¦æŸï¼‰

è¾“å…¥ï¼šèŒƒå›´ã€æ˜¯å¦å…è®¸å‡é™å·ã€è°±å·
è¾“å‡ºï¼štargetMidi

è§„åˆ™ï¼š

* `accidentalMode=off` æ—¶åªç”Ÿæˆç™½é”®ï¼ˆè‡ªç„¶éŸ³ï¼‰ã€‚
* `on` æ—¶ç™½é”®é»‘é”®éƒ½å¯ã€‚

```ts
export function generateRandomMidi(config: PracticeConfig, rng = Math.random): number {
  const { rangeMin, rangeMax, accidentalMode } = config;
  const candidates: number[] = [];
  for (let m = rangeMin; m <= rangeMax; m++) {
    if (m < PIANO_MIN || m > PIANO_MAX) continue;
    if (accidentalMode === "off" && isBlackKey(m)) continue;
    candidates.push(m);
  }
  const idx = Math.floor(rng() * candidates.length);
  return candidates[idx];
}
```

### 8.4 MIDI å·è½¬ VexFlow key å­—ç¬¦ä¸²

VexFlow éœ€è¦å½¢å¦‚ `"c#/4"` çš„ keyï¼š

* octaveï¼šMIDI 60 = C4ï¼ˆä¸­å¤® Cï¼‰
* éŸ³åï¼šç”¨ä¼˜å…ˆå‡å·æˆ–ä¼˜å…ˆé™å·ç­–ç•¥ï¼ˆMVP ç»Ÿä¸€ç”¨å‡å·å³å¯ï¼Œç®€å•ï¼‰

```ts
const NOTE_NAMES_SHARP = ["c","c#","d","d#","e","f","f#","g","g#","a","a#","b"];

export function midiToVexflowKey(midi: number): string {
  const pc = midi % 12;
  const name = NOTE_NAMES_SHARP[pc]; // "c#"
  const octave = Math.floor(midi / 12) - 1; // MIDIæ ‡å‡†ï¼šC4(60) -> 4
  return `${name}/${octave}`;
}
```

> è¯´æ˜ï¼šå¦‚æœä½ æƒ³åœ¨ UI ä¸Šæ˜¾ç¤º â€œDbâ€ è€Œä¸æ˜¯ â€œC#â€ï¼Œå¯ä»¥åç»­åŠ â€œåå¥½å‡å·/é™å·â€å¼€å…³ï¼Œä½† MVP ä¸éœ€è¦ã€‚

### 8.5 åˆ¤å®šé€»è¾‘ï¼ˆçŠ¶æ€æœºï¼‰

ç»ƒä¹ é¡µçŠ¶æ€ï¼š

* `idle`ï¼ˆæœªå¼€å§‹ï¼‰
* `showingQuestion`ï¼ˆå±•ç¤ºé¢˜ç›®ï¼Œç­‰å¾…è¾“å…¥ï¼‰
* `feedbackCorrect`ï¼ˆæ­£ç¡®åé¦ˆï¼Œå‡†å¤‡ä¸‹ä¸€é¢˜ï¼‰
* `feedbackWrong`ï¼ˆé”™è¯¯åé¦ˆï¼Œç»§ç»­ç­‰å¾…ï¼‰
* `finished`ï¼ˆå±•ç¤ºç»“æœï¼‰

åˆ¤å®šä¼ªä»£ç ï¼š

```ts
onQuestionShown():
  attempt = { inputs: [], firstInputAtMs: null }

onUserInput(midi):
  now = Date.now()
  if attempt.firstInputAtMs == null:
    attempt.firstInputAtMs = now

  correct = (midi === question.targetMidi)
  attempt.inputs.push({ midi, atMs: now, correct })

  if correct:
    attempt.resolvedAtMs = now
    session.streak++
    session.maxStreak = max(session.maxStreak, session.streak)
    goToNextQuestionSoon()
  else:
    session.streak = 0
    showWrongKeyHighlight(midi)
```

### 8.6 ç»Ÿè®¡è®¡ç®—

* `accuracyByFirstTry`ï¼šæ¯é¢˜çš„ç¬¬ä¸€æ¬¡è¾“å…¥æ˜¯å¦æ­£ç¡®
* `avgReactionMs`ï¼šæ¯é¢˜ `firstInputAtMs - questionShownAtMs` å¹³å‡

ä¸ºç®€å•ï¼Œè®°å½•æ¯é¢˜ `questionShownAtMs` å³å¯ã€‚

---

## 9. UI ç»„ä»¶æ‹†åˆ†ï¼ˆCodex å¯æŒ‰æ¨¡å—å®ç°ï¼‰

### 9.1 ç»„ä»¶æ¸…å•

1. `StaffNote`ï¼šäº”çº¿è°±æ¸²æŸ“ç»„ä»¶ï¼ˆVexFlowï¼‰
2. `PianoKeyboard`ï¼š88 é”®é”®ç›˜ï¼ˆå¯æ¨ªå‘æ»šåŠ¨/ç¼©æ”¾ï¼‰
3. `Key`ï¼šå•ä¸ªç´é”®ï¼ˆç™½é”®/é»‘é”®ï¼‰
4. `TopBar`ï¼šé¢˜å·ã€streakã€è®¡æ—¶
5. `FeedbackToast`ï¼šå¯¹/é”™è½»æç¤ºï¼ˆå¯é€‰ï¼‰
6. `SettingsForm`ï¼šè®¾ç½®è¡¨å•

### 9.2 PianoKeyboard å…³é”®äº¤äº’

* é”®ç›˜æŒ‰é”®ç‚¹å‡»è§¦å‘ `onKeyDown(midi)`
* é«˜äº®è§„åˆ™ï¼š

  * å½“å‰é¢˜ç›®æ ‡é”®ï¼šå¯é€‰é«˜äº®ï¼ˆâ€œæç¤ºæ¨¡å¼â€æ‰äº®ï¼ŒMVP é»˜è®¤ä¸æç¤ºï¼‰
  * é”™è¯¯é”®ï¼šçŸ­æš‚çº¢è‰²é—ªçƒï¼ˆä¾‹å¦‚ 300msï¼‰
  * æ­£ç¡®é”®ï¼šç»¿è‰²é—ªçƒå¹¶ä¿ç•™åˆ°ä¸‹ä¸€é¢˜åˆ‡æ¢

é”®ç›˜æ˜¾ç¤ºç­–ç•¥ï¼ˆç®€åŒ–ï¼‰ï¼š

* æ¡Œé¢ï¼šé»˜è®¤æ˜¾ç¤ºå…¨ 88 é”®ï¼Œå…è®¸ç¼©æ”¾
* ç§»åŠ¨ç«¯ï¼šé»˜è®¤æ˜¾ç¤ºä¸€ä¸ªçª—å£ï¼ˆä¾‹å¦‚ 2 ä¸ªå…«åº¦å®½ï¼‰ï¼Œå·¦å³æ»‘åŠ¨æ»šåŠ¨

å®ç°æ–¹å¼ï¼š

* ç™½é”®ç”¨ flex æ¨ªæ’
* é»‘é”®ç”¨ç»å¯¹å®šä½å åŠ åœ¨ç™½é”®ä¸Šæ–¹ï¼ˆå¸¸è§é’¢ç´é”®ç›˜å¸ƒå±€ï¼‰

---

## 10. è·¯ç”±ä¸é¡µé¢è¡Œä¸º

ä½¿ç”¨ `react-router-dom`ï¼š

* `/` Home
* `/settings` Settings
* `/practice` Practice
* `/results` Results

Practice é¡µè¿›å…¥æ—¶ï¼š

1. è¯»å– config
2. ç”Ÿæˆ questions æ•°ç»„
3. åˆå§‹åŒ– session ä¸ attempts
4. å±•ç¤ºç¬¬ä¸€é¢˜å¹¶è®°ä¸‹ `questionShownAtMs`

Results é¡µï¼š

* ä» store è¯»å–æœ€å sessionResult
* å±•ç¤º summaryï¼Œå¹¶æä¾›æŒ‰é’®ï¼š

  * â€œå†æ¥ä¸€ç»„â€ï¼ˆå›åˆ° /practiceï¼‰
  * â€œè°ƒæ•´è®¾ç½®â€ï¼ˆå» /settingsï¼‰
  * â€œå›é¦–é¡µâ€ï¼ˆå» /ï¼‰

---

## 11. å·¥ç¨‹ç»“æ„ï¼ˆå»ºè®®ç›®å½•ï¼‰

```
sightkey/
  index.html
  vite.config.ts
  package.json
  src/
    main.tsx
    app/
      App.tsx
      router.tsx
      store.ts              // zustand store
      types.ts              // å…¨å±€ç±»å‹
      constants.ts
    pages/
      HomePage.tsx
      SettingsPage.tsx
      PracticePage.tsx
      ResultsPage.tsx
    components/
      StaffNote.tsx
      PianoKeyboard/
        PianoKeyboard.tsx
        Key.tsx
        layout.ts          // é»‘é”®ä½ç½®è®¡ç®—
      TopBar.tsx
    lib/
      midi.ts              // Web MIDI æ¥å…¥
      note.ts              // midi <-> vexflow ç­‰
      random.ts
      storage.ts
      stats.ts
    styles/
      globals.css
    tests/
      note.test.ts
      stats.test.ts
```

---

## 12. Web MIDI æ¥å…¥è§„èŒƒï¼ˆå¯é€‰ä½†æ¨èï¼‰

### 12.1 åŠŸèƒ½è¦æ±‚

* è‹¥æµè§ˆå™¨æ”¯æŒ Web MIDIï¼š

  * Settings ä¸­å…è®¸é€‰æ‹©è¾“å…¥è®¾å¤‡
  * Practice é¡µé¢ç›‘å¬ note onï¼ˆvelocity > 0ï¼‰ä½œä¸ºè¾“å…¥
* ä¸æ”¯æŒåˆ™ï¼š

  * è‡ªåŠ¨é™çº§ï¼Œä»…å±å¹•é”®ç›˜
  * Settings é‡Œéšè— MIDI é€‰é¡¹æˆ–æç¤ºâ€œå½“å‰æµè§ˆå™¨ä¸æ”¯æŒ MIDIâ€

### 12.2 MIDI å®ç°æ¥å£

```ts
export interface MidiService {
  isSupported: boolean;
  init(): Promise<void>;
  listInputs(): Array<{ id: string; name: string }>;
  selectInput(id: string): void;
  onNoteOn(cb: (midi: number, velocity: number) => void): () => void; // è¿”å› unsubscribe
}
```

---

## 13. è§†è§‰ä¸äº¤äº’åŸºè°ƒï¼ˆç»™å®ç°è€…çš„å‡†ç»³ï¼‰

* æ•´ä½“é£æ ¼ï¼šå¹²å‡€ã€ç»ƒä¹ å™¨ææ„Ÿï¼ˆåƒèŠ‚æ‹å™¨ï¼Œä¸åƒç¤¾äº¤è½¯ä»¶ï¼‰
* åŠ¨æ•ˆï¼šå¯¹é”™æç¤ºçŸ­ä¿ƒï¼Œä¸æ‰“æ–­èŠ‚å¥
* é”™è¯¯å¤„ç†ï¼šé”™äº†åˆ«ç¾è¾±ï¼Œç»™â€œå†è¯•ä¸€æ¬¡â€çš„ç©ºé—´ ğŸ¥
* å¯è®¿é—®æ€§ï¼š

  * é”®ç›˜é”®å¯è¢«ç‚¹å‡»åŒºåŸŸè¶³å¤Ÿå¤§ï¼ˆç§»åŠ¨ç«¯æœ€å° 44px è§¦æ§é«˜åº¦åŸåˆ™ï¼‰
  * é«˜å¯¹æ¯”åº¦ï¼ˆå¯¹é”™é¢œè‰²è¦å…¼é¡¾è‰²ç›²ï¼Œå»ºè®®åŒæ—¶åŠ æè¾¹/å›¾æ ‡ï¼‰

---

## 14. æµ‹è¯•ç”¨ä¾‹ï¼ˆæœ€å°‘ä½†å…³é”®ï¼‰

### 14.1 å•å…ƒæµ‹è¯•

* `midiToVexflowKey(60) === "c/4"`
* é»‘é”®åˆ¤æ–­ï¼š61(C#) æ˜¯é»‘é”®ï¼Œ60(C) æ˜¯ç™½é”®
* `generateRandomMidi` åœ¨ accidentalMode off æ—¶ä¸ç”Ÿæˆé»‘é”®
* `stats`ï¼š

  * æ­£ç¡®ç‡è®¡ç®—
  * å¹³å‡ååº”æ—¶é—´è®¡ç®—

### 14.2 ç®€å•äº¤äº’æµ‹è¯•ï¼ˆå¯æ‰‹æµ‹æ¸…å•ï¼‰

* Settings æ”¹éŸ³åŸŸåï¼Œç»ƒä¹ ç¡®å®åªå‡ºè¯¥èŒƒå›´éŸ³
* å¼€å¯å‡é™å·åä¼šå‡ºç°é»‘é”®éŸ³
* é”™è¯¯æ—¶ streak å½’é›¶ï¼Œæ­£ç¡®å streak å¢åŠ 
* Results æ˜¾ç¤ºä¸è¿‡ç¨‹ä¸€è‡´

---

## 15. é‡Œç¨‹ç¢‘ä¸ä»»åŠ¡æ‹†è§£ï¼ˆCodex ç›´æ¥æŒ‰æ¸…å•å†™ï¼‰

### Milestone Aï¼šå·¥ç¨‹åˆå§‹åŒ–

1. Vite React TS åˆå§‹åŒ–
2. å¼•å…¥ Tailwind
3. å¼•å…¥ react-router-domã€zustandã€vexflow
4. é… PWA

### Milestone Bï¼šæ ¸å¿ƒè¯†è°±æ¸²æŸ“

1. `StaffNote`ï¼šç»™å®š `vexflowKey` æ¸²æŸ“å•éŸ³ç¬¦
2. æ”¯æŒ treble/bass åˆ‡æ¢

### Milestone Cï¼šé”®ç›˜ç»„ä»¶

1. 88 é”®å¸ƒå±€ï¼ˆç™½é”®ä¸€å±‚ + é»‘é”®å å±‚ï¼‰
2. ç‚¹å‡»è¾“å‡º midi
3. é«˜äº®æ­£ç¡®/é”™è¯¯é”®

### Milestone Dï¼šç»ƒä¹ æµç¨‹

1. storeï¼šconfigã€sessionã€currentQuestionIndex
2. ç”Ÿæˆé¢˜ç›®åˆ—è¡¨ã€è®°å½• attempt
3. åˆ¤å®šé€»è¾‘ä¸è‡ªåŠ¨ä¸‹ä¸€é¢˜
4. ç»“ç®—é¡µç»Ÿè®¡

### Milestone Eï¼šMIDIï¼ˆå¯é€‰ï¼‰

1. Web MIDI init + input list + select
2. note on æ˜ å°„åˆ°åˆ¤å®šé€»è¾‘

---

## 16. ç»™ Codex çš„â€œç›´æ¥å¼€å·¥æŒ‡ä»¤â€ï¼ˆå¯æ•´æ®µå¤åˆ¶ç²˜è´´ï¼‰

ä¸‹é¢è¿™æ®µä½ å¯ä»¥åŸæ ·å‘ç»™ Codexï¼Œè®©å®ƒæŒ‰æ­¥éª¤å†™å®Œæ•´é¡¹ç›®ï¼š

```text
ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªåä¸º sightkey çš„ Vite + React + TS çš„ PWAï¼Œç”¨äºé’¢ç´è¯†è°±ç»ƒä¹ ï¼ˆå•éŸ³ç¬¦ï¼‰ã€‚å¿…é¡»åŒ…å«ï¼šäº”çº¿è°±æ˜¾ç¤ºã€88é”®é”®ç›˜ã€åˆ¤å®šå¯¹é”™ã€è®¾ç½®é¡µã€ç»“æœé¡µã€æœ¬åœ°å­˜å‚¨ã€‚å¯é€‰ï¼šWeb MIDI è¾“å…¥ã€‚

æŠ€æœ¯æ ˆä¸ä¾èµ–ï¼š
- react, react-dom, react-router-dom
- typescript, vite
- tailwindcss
- zustand
- vexflow
- vitest, @testing-library/react
- vite-plugin-pwa

é¡µé¢ï¼š
1) / Homeï¼šæŒ‰é’®â€œå¼€å§‹ç»ƒä¹ â€â€œè®¾ç½®â€ï¼Œå±•ç¤ºæœ€è¿‘ä¸€æ¬¡æˆç»©ï¼ˆä» localStorage è¯»å–ï¼‰ã€‚
2) /settings Settingsï¼šå¯é…ç½® clef(treble/bass)ã€rangeMin/rangeMax(ä½¿ç”¨ä¸‹æ‹‰ï¼ŒèŒƒå›´é™åˆ¶ 21-108)ã€accidentalMode(off/on)ã€showNoteNamesOnKeysã€questionsPerSession(10/20/30)ã€inputMode(screen/midiï¼Œå¦‚æœä¸æ”¯æŒ MIDI åˆ™åªæ˜¾ç¤º screen)ã€‚ä¿å­˜åˆ° localStorageã€‚
3) /practice Practiceï¼šé¡¶éƒ¨æ˜¾ç¤ºé¢˜å·ã€streakï¼›ä¸­é—´ StaffNote æ¸²æŸ“å•éŸ³ç¬¦ï¼›åº•éƒ¨ PianoKeyboard 88é”®ã€‚ç”¨æˆ·ç‚¹å‡»é”®æˆ– MIDI note on è¾“å…¥ï¼Œè‹¥ midi==targetMidi åˆ™åˆ¤å®šæ­£ç¡®ï¼ˆç»¿è‰²é«˜äº®ï¼Œ300-500ms åä¸‹ä¸€é¢˜ï¼‰ï¼Œå¦åˆ™é”™è¯¯ï¼ˆçº¢è‰²é«˜äº®é”™è¯¯é”®ï¼Œå…è®¸ç»§ç»­å°è¯•ï¼‰ã€‚è®°å½•æ¯é¢˜ attemptï¼šquestionShownAtMsã€firstInputAtMsã€inputs[]ã€resolvedAtMsã€‚ç»“æŸåè·³è½¬ /resultsã€‚
4) /results Resultsï¼šå±•ç¤º accuracyByFirstTryã€avgReactionMsã€maxStreakï¼ŒæŒ‰é’®â€œå†æ¥ä¸€ç»„â€â€œè°ƒæ•´è®¾ç½®â€â€œå›é¦–é¡µâ€ã€‚ä¿å­˜ sessionResult åˆ° localStorageï¼ˆlast_result å’Œ history æœ€å¤š50æ¡ï¼‰ã€‚

æ ¸å¿ƒé€»è¾‘ï¼š
- é’¢ç´èŒƒå›´ï¼šPIANO_MIN=21, PIANO_MAX=108ã€‚keyIndex=midi-21ã€‚
- accidentalMode=off æ—¶é¢˜åº“åªå‡ºç™½é”®ï¼›on æ—¶ç™½é»‘é”®éƒ½å¯ã€‚
- midiToVexflowKeyï¼šä½¿ç”¨å‡å·è¡¨ NOTE_NAMES_SHARPï¼ŒæŠŠ midi è½¬æˆ "c#/4" å½¢å¼ã€‚octave=Math.floor(midi/12)-1ã€‚
- generateRandomMidiï¼šåœ¨èŒƒå›´å†…ç”Ÿæˆå€™é€‰æ•°ç»„å¹¶éšæœºå–ä¸€ä¸ªã€‚
- statsï¼šaccuracyByFirstTryï¼ˆæ¯é¢˜ç¬¬ä¸€æ¬¡è¾“å…¥æ­£ç¡®çš„æ¯”ä¾‹ï¼‰ï¼›avgReactionMsï¼ˆfirstInputAtMs - questionShownAtMs å¹³å‡ï¼‰ï¼›maxStreakã€‚

ç»„ä»¶ï¼š
- StaffNote.tsxï¼šç”¨ VexFlow åœ¨ canvas æˆ– svg æ¸²æŸ“ï¼Œæ”¯æŒ clef treble/bassã€‚
- PianoKeyboardï¼šæ¸²æŸ“ 88 é”®ï¼Œç™½é”®ä¸€å±‚ï¼Œé»‘é”®ç»å¯¹å®šä½å åŠ ã€‚æ”¯æŒé«˜äº® statesï¼šnone/wrong/correctã€‚
- SettingsFormï¼šè¡¨å•æ§ä»¶ä¸æ ¡éªŒï¼ˆrangeMin < rangeMaxï¼‰ã€‚

å·¥ç¨‹ç»“æ„æŒ‰ä»¥ä¸‹ç›®å½•åˆ›å»ºå¹¶å®ç°ï¼š
src/app, src/pages, src/components, src/lib, src/tests
å¹¶å†™ READMEï¼šå¼€å‘å¯åŠ¨ã€æ„å»ºã€PWAã€MIDI æ”¯æŒè¯´æ˜ã€‚

æµ‹è¯•ï¼š
- note.test.tsï¼šmidiToVexflowKeyã€isBlackKey
- stats.test.tsï¼šç»Ÿè®¡è®¡ç®—

è¯·ç›´æ¥è¾“å‡ºå®Œæ•´å¯è¿è¡Œä»£ç ï¼ˆå« package.jsonã€vite é…ç½®ã€tailwind é…ç½®ã€PWA é…ç½®ã€æ‰€æœ‰ tsx/ts æ–‡ä»¶ï¼‰ã€‚
```

---

## 17. åç»­è¿­ä»£è·¯çº¿å›¾ï¼ˆä¸å½±å“ MVPï¼Œä½†ä½ ä¼šæƒ³è¦ï¼‰

* æ··åˆè°±å·ï¼šé¢˜ç›®éšæœºåœ¨é«˜éŸ³/ä½éŸ³é—´åˆ‡æ¢
* é¢˜å‹ï¼šéŸ³ç¨‹ï¼ˆä¸¤ä¸ªéŸ³åŒæ—¶å‡ºç°ï¼‰ã€ç®€å•å’Œå¼¦ï¼ˆ3éŸ³ï¼‰
* èŠ‚å¥æ¨¡å¼ï¼šåŠ å…¥èŠ‚æ‹å™¨ä¸æ—¶å€¼åˆ¤å®š
* è®­ç»ƒè®¡åˆ’ï¼šæ¯å¤© 3 åˆ†é’Ÿæ‰“å¡ï¼Œä½†ä¿æŒâ€œç»ƒä¹ å™¨æâ€æ°”è´¨ï¼Œä¸è¦åšæˆæ¸¸æˆå†…è´­å®‡å®™ ğŸ™ƒ

---

å¦‚æœä½ å¸Œæœ›æˆ‘æŠŠè¿™ä¸ªè§„åˆ’ä¹¦è¿›ä¸€æ­¥â€œå˜æˆæ›´åƒ PRD + æŠ€æœ¯è®¾è®¡æ–‡æ¡£çš„æ ¼å¼â€ï¼Œæ¯”å¦‚åŠ ä¸Šæ›´ä¸¥æ ¼çš„éªŒæ”¶è¡¨ã€æ¯ä¸ªé¡µé¢çš„çº¿æ¡†å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰ã€ä»¥åŠé”®ç›˜å¸ƒå±€çš„ç²¾ç¡®åƒç´ ç­–ç•¥ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç›´æ¥è¡¥é½åˆ°å¯å½“ä½œå¼€å‘åˆåŒçš„ç¨‹åº¦ã€‚

# é’¢ç´è¯†è°±ç»ƒä¹  App è§„åˆ’ä¹¦ï¼ˆæ”¯æŒè°±é¢å›¾ç‰‡è¯†åˆ« + ç´é”®å¯¹åº” + èŠ‚å¥è®­ç»ƒï¼‰v1.0

> ç›®æ ‡ï¼šä½ æŠŠä¸€å¼ ï¼ˆæˆ–å¤šå¼ ï¼‰è°±å­å›¾ç‰‡ä¸¢è¿›æ¥ï¼ŒApp è‡ªåŠ¨æŠŠå®ƒâ€œç¿»è¯‘â€ä¸ºå¯ç»ƒä¹ çš„æ•°æ®ï¼šè¯†åˆ«è°ƒå·/æ‹å·/éŸ³ç¬¦ä¸æ—¶å€¼ï¼Œç„¶åç”¨å¯è§†åŒ–è°±é¢ + å¯¹åº”ç´é”® + è®¡åˆ†æœºåˆ¶ï¼Œå¸¦ä½ ç»ƒè¯†è°±ä¸æ‹å­ã€‚
> å£å‘³ï¼šå°½é‡ç®€å•ã€å¯è½åœ°ã€æ–‡æ¡£å¯ç›´æ¥äº¤ç»™ Codex æŒ‰å›¾æ–½å·¥ã€‚

---

## 1. äº§å“å®šä½ä¸æ ¸å¿ƒä½“éªŒ

### 1.1 ä½ è¦è§£å†³çš„ç—›ç‚¹

* åªæœ‰è°±å­å›¾ç‰‡ï¼ˆä¸æ˜¯ MusicXML/MIDIï¼‰ï¼Œæƒ³é’ˆå¯¹â€œè¿™å¼ è°±â€ç»ƒè¯†è°±ä¸æŒ‰é”®ã€‚
* çœ‹ä¸æ‡‚æ‹å­/æ—¶å€¼ï¼Œå¸Œæœ›æœ‰â€œæ–°æ‰‹æç¤ºæŒ‰å¤šä¹…â€ï¼Œè¿˜èƒ½ç§¯åˆ†ã€‚
* æƒ³æŠŠè°±é¢ä¸Šçš„éŸ³ç¬¦ä¸ç´é”®ä¸€ä¸€å¯¹åº”ï¼ˆå±å¹•ç´é”® + å¯é€‰å¤–æ¥ MIDI é”®ç›˜ï¼‰ã€‚

### 1.2 ä¸€å¥è¯ä½“éªŒ

**ä¸Šä¼ è°±é¢å›¾ â†’ è‡ªåŠ¨è¯†åˆ« â†’ ç›´æ¥åœ¨è°±å­ä¸Šé€éŸ³/é€èŠ‚å¥ç»ƒ â†’ æŒ‰å¯¹åŠ åˆ†ï¼ŒæŒ‰é”™æç¤º**ï¼ˆæ–°æ‰‹æ¨¡å¼ä¼šæç¤ºæŒ‰å¤šä¹…ï¼Œæ™®é€šæ¨¡å¼ä¸æç¤ºï¼‰ã€‚

---

## 2. MVP åŠŸèƒ½èŒƒå›´ï¼ˆå…ˆåšâ€œèƒ½ç”¨ä¸”çˆ½â€çš„æœ€å°é—­ç¯ï¼‰

### 2.1 å¯¼å…¥ä¸è¯†åˆ«ï¼ˆOMRï¼‰

* âœ… å¯¼å…¥ï¼šæ”¯æŒä¸Šä¼  1 å¼ å›¾ç‰‡ï¼ˆJPG/PNGï¼‰ï¼›å¯æ‰©å±•ä¸ºå¤šå¼ ï¼ˆæŒ‰é¡µï¼‰ã€‚
* âœ… OMR è¯†åˆ«ï¼šæŠŠè°±é¢å›¾è½¬æˆ MusicXMLï¼ˆåç»­æ¸²æŸ“ä¸ç»ƒä¹ éƒ½é å®ƒï¼‰ã€‚
* âœ… è‡ªåŠ¨æå–ï¼š

  * è°ƒå·ï¼ˆkey signatureï¼šå‡ ä¸ªå‡/é™å·ï¼‰
  * æ‹å·ï¼ˆtime signatureï¼šå¦‚ 4/4ã€3/8ï¼‰
  * éŸ³ç¬¦åºåˆ—ï¼ˆå«ä¼‘æ­¢ï¼‰ã€éŸ³é«˜ã€æ—¶å€¼ï¼ˆç”¨äºèŠ‚å¥è®­ç»ƒï¼‰

> OMR å¼•æ“é€‰ç”¨ **Audiveris**ï¼ˆå¼€æº OMRï¼Œå¯å¯¼å‡º MusicXMLï¼‰ã€‚å®ƒæ”¯æŒæ‰¹å¤„ç†å‘½ä»¤è¡Œæ¨¡å¼ä¸å¯¼å‡º MusicXMLã€‚([Audiveris][1])

### 2.2 è°±é¢æ˜¾ç¤ºï¼ˆå¯è§†åŒ–ï¼‰

* âœ… æŠŠè¯†åˆ«å‡ºçš„ MusicXML æ¸²æŸ“æˆå¯æ»šåŠ¨è°±é¢ï¼ˆé«˜éŸ³è°±è¡¨/ä½éŸ³è°±è¡¨éƒ½æ˜¾ç¤ºï¼‰ã€‚
* âœ… ç»ƒä¹ æ—¶é«˜äº®å½“å‰éŸ³ç¬¦/å½“å‰å°èŠ‚ï¼ˆå…‰æ ‡è·Ÿéšï¼‰ã€‚

> å‰ç«¯æ¸²æŸ“ç”¨ **OpenSheetMusicDisplay (OSMD)**ï¼šåœ¨æµè§ˆå™¨/åº”ç”¨é‡Œæ¸²æŸ“ MusicXMLï¼Œå¸¦ Cursorï¼ˆå…‰æ ‡ï¼‰èƒ½åŠ›ã€‚([Open Sheet Music Display][2])

### 2.3 è¯†è°±è®­ç»ƒï¼ˆå¯¹åº”ç´é”®ï¼‰

* âœ… ä¸¤ç§è¾“å…¥ï¼š

  1. å±å¹•é’¢ç´é”®ç›˜ï¼ˆé¼ æ ‡/è§¦æ§æŒ‰ä¸‹ä¸æ¾å¼€ï¼‰
  2. å¤–æ¥ MIDI é”®ç›˜ï¼ˆWeb MIDIï¼ŒChrome/Edge ä½“éªŒæœ€å¥½ï¼‰
* âœ… ä¸¤ç§ç»ƒæ³•ï¼ˆMVP æ¨èå…ˆåš Aï¼Œå†åš Bï¼‰

  * A. **é€éŸ³é—¯å…³**ï¼šä»è°±å­é‡ŒæŒ‰é¡ºåºå–â€œä¸‹ä¸€ç»„è¦å¼¹çš„éŸ³â€ï¼ˆå¯åªå–ä¸»æ—‹å¾‹/ä¸Šå£°éƒ¨ï¼‰ï¼ŒæŒ‰å¯¹è¿›å…¥ä¸‹ä¸€ç»„ã€‚
  * B. **éšæœºæŠ½é¢˜**ï¼šåªä»è¿™å¼ è°±å‡ºç°è¿‡çš„éŸ³ç¬¦é›†åˆé‡ŒéšæœºæŠ½ï¼Œä¸“ç»ƒè¯†è°±ååº”ã€‚

### 2.4 èŠ‚å¥/æ‹å­è®­ç»ƒï¼ˆä½ ç‰¹åˆ«æƒ³è¦çš„ï¼‰

* âœ… è®­ç»ƒç›®æ ‡ï¼šç»ƒâ€œä»€ä¹ˆæ—¶å€™æŒ‰ + æŒ‰å¤šä¹…ï¼ˆæ—¶å€¼ï¼‰â€ã€‚
* âœ… è®­ç»ƒå½¢å¼ï¼šæŠŠè°±å­é‡Œçš„èŠ‚å¥æŠ½å‡ºæ¥ï¼Œä½†**åªç”¨ 1 ä¸ªé”®æˆ– 2 ä¸ªé”®**æ¥ç»ƒï¼ˆé¿å…ä½ è¿˜è¦åˆ†å¿ƒæ‰¾éŸ³é«˜ï¼‰ã€‚

  * 1 é”®æ¨¡å¼ï¼šæ‰€æœ‰â€œéŸ³ç¬¦äº‹ä»¶â€éƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªé”®ï¼ˆé»˜è®¤ C4ï¼‰
  * 2 é”®æ¨¡å¼ï¼šæŒ‰äº‹ä»¶äº¤æ›¿æ˜ å°„åˆ°ä¸¤ä¸ªé”®ï¼ˆé»˜è®¤ C4/D4ï¼‰ï¼Œè®­ç»ƒæ›´åƒâ€œèµ°è·¯å·¦å³è„šâ€
* âœ… ä¸¤ä¸ªæ¨¡å¼ï¼š

  * **æ–°æ‰‹æ¨¡å¼**ï¼šæ˜¾ç¤ºéŸ³ç¬¦ + æ˜ç¡®æç¤ºè¦æŒ‰å¤šä¹…ï¼ˆä¾‹å¦‚â€œæŒ‰ 1 æ‹â€â€œæŒ‰ 0.5 æ‹â€ï¼‰ï¼Œå¹¶æ˜¾ç¤ºå€’è®¡æ—¶è¿›åº¦æ¡ï¼›æŒ‰å¯¹å¾—åˆ†ã€‚
  * **æ™®é€šæ¨¡å¼**ï¼šä¸æç¤ºæŒ‰å¤šä¹…ï¼Œåªç»™è°±é¢ä¸èŠ‚æ‹å™¨ï¼›æŒ‰å¯¹å¾—åˆ†ã€‚

### 2.5 è®¡åˆ†ä¸åé¦ˆï¼ˆMVPï¼‰

* âœ… è¯„åˆ†ç»´åº¦ï¼š

  * Onsetï¼ˆæŒ‰ä¸‹æ—¶åˆ»æ˜¯å¦å¡ç‚¹ï¼‰
  * Holdï¼ˆæŒ‰ä½æ—¶é•¿æ˜¯å¦æ¥è¿‘ç›®æ ‡æ—¶å€¼ï¼‰
  * Restï¼ˆä¼‘æ­¢æ—¶æ˜¯å¦ä¹±æŒ‰ï¼ŒMVP å¯å…ˆä¸æƒ©ç½šï¼Œåç»­åŠ ï¼‰
* âœ… è¾“å‡ºï¼š

  * æœ¬æ¬¡å¾—åˆ†ã€è¿å‡»ã€å¹³å‡æå‰/æ»åï¼ˆmsï¼‰
  * é”™è¯¯å›æ”¾ï¼šæ ‡å‡ºæœ€å¸¸é”™çš„èŠ‚å¥å‹/å°èŠ‚

---

## 3. éç›®æ ‡ï¼ˆv1.0 å…ˆä¸åšï¼Œé¿å…çˆ†ç‚¸ï¼‰

* âŒ è‡ªåŠ¨åˆ¤æ–­â€œæ˜¯å¤§è°ƒè¿˜æ˜¯å°è°ƒçš„ä¸»è°ƒâ€ï¼ˆåªåš**è°ƒå·**è¯†åˆ«ï¼šå‡ ä¸ªå‡/é™å·ï¼›å¹¶æç¤ºâ€œå¯èƒ½çš„ç›¸å¯¹å¤§/å°è°ƒâ€ï¼‰
* âŒ å¤šå£°éƒ¨å¤æ‚å’Œå¼¦ç²¾ç¡®ç»ƒä¹ ï¼ˆMVP å…ˆç”¨â€œä¸Šå£°éƒ¨/ä¸»æ—‹å¾‹ç­–ç•¥â€æˆ–â€œæ¯ä¸ªæ—¶é—´ç‚¹å–æœ€é«˜éŸ³â€ï¼‰
* âŒ å¤æ‚é€Ÿåº¦å˜åŒ–ã€rubato ç²¾ç»†è·Ÿè¸ªï¼ˆå…ˆè®©ç”¨æˆ·æ‰‹åŠ¨è®¾ BPM æˆ–ç”¨é»˜è®¤ BPMï¼‰

---

## 4. å…³é”®æŠ€æœ¯è·¯çº¿ï¼ˆå°½é‡ç®€å•ä½†é è°±ï¼‰

## 4.1 æ€»ä½“æ¶æ„ï¼ˆæ¨èï¼šæœ¬åœ°è‡ªæ‰˜ç®¡ï¼Œæœ€çœäº‹ï¼‰

**PWA å‰ç«¯ + æœ¬åœ°åç«¯æœåŠ¡ + Audiveris OMR å¼•æ“**

* å‰ç«¯ï¼ˆWeb/PWAï¼‰ï¼šè´Ÿè´£ UIã€è°±é¢æ¸²æŸ“ã€ç»ƒä¹ é€»è¾‘ã€è®¡åˆ†ã€è¾“å…¥é‡‡é›†ï¼ˆè§¦æ§/MIDIï¼‰ã€‚
* åç«¯ï¼ˆæœ¬åœ° Node æœåŠ¡ï¼‰ï¼šè´Ÿè´£å›¾ç‰‡ä¸Šä¼ ã€è°ƒç”¨ Audiverisã€è¾“å‡º MusicXMLï¼ˆä»¥åŠåŸºç¡€è§£æï¼šè°ƒå·/æ‹å·ï¼‰ã€‚
* Audiverisï¼šè´Ÿè´£ OMRï¼ŒæŠŠå›¾ç‰‡å˜æˆ MusicXMLã€‚æ”¯æŒå‘½ä»¤è¡Œæ‰¹å¤„ç†ä¸å¯¼å‡ºã€‚([Bacchus HLG][3])

> ä¸ºä»€ä¹ˆä¸çº¯å‰ç«¯ï¼Ÿå› ä¸º OMR å¾ˆé‡ï¼ˆJava/åŸç”Ÿä¾èµ–ï¼‰ï¼Œæµè§ˆå™¨é‡Œå¾ˆéš¾å¯é è·‘ã€‚
> ä¸ºä»€ä¹ˆè¯´â€œç®€å•â€ï¼Ÿå› ä¸ºå®ƒæ˜¯â€œä¸€ä¸ª Docker Compose å°±èƒ½è·‘â€çš„é‚£ç§ç®€å•ã€‚

---

## 4.2 æŠ€æœ¯æ ˆæ¸…å•ï¼ˆMVP æœ€å°ç»„åˆï¼‰

### å‰ç«¯ï¼ˆWeb/PWAï¼‰

* **TypeScript + React**
* **Vite**ï¼ˆæ„å»ºï¼‰
* **OpenSheetMusicDisplay (OSMD)**ï¼ˆæ¸²æŸ“ MusicXML + Cursor é«˜äº®ï¼‰([Open Sheet Music Display][2])
* **Web Audio API**ï¼ˆèŠ‚æ‹å™¨ clickã€è®¡æ—¶åŸºå‡†ï¼‰
* **Web MIDI API**ï¼ˆå¯é€‰ï¼šå¤–æ¥ MIDI é”®ç›˜è¾“å…¥ï¼‰([MDN Web Docs][4])
* çŠ¶æ€ç®¡ç†ï¼šè½»é‡ç”¨ **Zustand** æˆ– React Contextï¼ˆä»»é€‰å…¶ä¸€ï¼‰
* æœ¬åœ°å­˜å‚¨ï¼šIndexedDBï¼ˆç”¨ idb-keyvalï¼‰æˆ– LocalStorageï¼ˆMVP å…ˆ LocalStorage + æ–‡ä»¶ç¼“å­˜ä¹Ÿè¡Œï¼‰

### åç«¯ï¼ˆæœ¬åœ°æœåŠ¡ï¼‰

* **Node.js + TypeScript**
* **Express**ï¼ˆæˆ– Fastifyï¼ŒMVP Express è¶³å¤Ÿï¼‰
* æ–‡ä»¶ä¸Šä¼ ï¼šmulter
* è°ƒç”¨å¤–éƒ¨è¿›ç¨‹ï¼šchild_process.spawn
* è§£æ/è§£å‹ .mxlï¼šadm-zip æˆ– jszip
  -ï¼ˆå¯é€‰ï¼‰æŒä¹…åŒ–ï¼šSQLiteï¼ˆbetter-sqlite3ï¼‰ï¼ŒMVP å…ˆæ–‡ä»¶ç³»ç»Ÿ JSON å°±è¡Œ

### OMR å¼•æ“

* **Audiveris**ï¼ˆAGPL-3.0ï¼Œæ³¨æ„è®¸å¯è¯åˆè§„ï¼‰([GitHub][5])
* å‘½ä»¤è¡Œå‚æ•°ï¼ˆå…³é”®ï¼‰ï¼š`-batch`ã€`-export`ã€`-output` ç­‰ã€‚([Bacchus HLG][3])

---

## 5. æ•°æ®ä¸ç®—æ³•è®¾è®¡ï¼ˆç»ƒä¹ å¼•æ“çš„å¿ƒè„ï¼‰

## 5.1 MusicXML ä¸­â€œè°ƒå·/æ‹å·/æ—¶å€¼â€çš„è¯»å–è§„åˆ™ï¼ˆæ ‡å‡†ï¼‰

* è°ƒå·ï¼šMusicXML ç”¨ `<fifths>` è¡¨ç¤ºå‡/é™å·æ•°é‡ï¼Œ**è´Ÿæ•°=é™å·ï¼Œæ­£æ•°=å‡å·**ã€‚([éŸ³ä¹XMLç”¨æˆ·æ‰‹å†Œ][6])
* æ‹å·ï¼š`<time>` é‡Œ `<beats>`ï¼ˆåˆ†å­ï¼‰å’Œ `<beat-type>`ï¼ˆåˆ†æ¯ï¼‰ã€‚([MusicXML][7])
* æ—¶å€¼ï¼š`<duration>` æ˜¯â€œdivision unitsâ€ï¼Œ`<divisions>` è¡¨ç¤ºâ€œæ¯ä¸ªå››åˆ†éŸ³ç¬¦æœ‰å¤šå°‘ divisionsâ€ã€‚([W3C][8])

> ä½ å¯ä»¥å®Œå…¨ä¸è‡ªå·±æ‰‹æ’¸ MusicXML çš„èŠ‚å¥å¯¹é½é€»è¾‘ï¼Œç›´æ¥è®© OSMD å¸®ä½ æŠŠéŸ³ç¬¦å’Œæ—¶é—´æˆ³ç®—å‡ºæ¥ï¼ˆè§ 5.3ï¼‰ã€‚

---

## 5.2 â€œè°ƒå·è¯†åˆ«â€è¾“å‡ºè®¾è®¡ï¼ˆç¬¦åˆä½ è¯´çš„â€œå‰é¢æœ‰é™éŸ³çš„é‚£ç§â€ï¼‰

è¯†åˆ«åˆ° `<fifths>` åï¼š

* æ˜¾ç¤ºï¼š`è°ƒå·ï¼š2ä¸ªé™å·ï¼ˆâ™­â™­ï¼‰`
* åŒæ—¶æç¤ºå¯èƒ½ä¸»è°ƒï¼ˆä¸å¼ºåˆ¤ï¼‰ï¼š

  * ä¾‹ï¼šfifths = -2 â†’ **å¯èƒ½æ˜¯ Bb å¤§è°ƒ / G å°è°ƒ**
* æä¾›â€œæ‰‹åŠ¨æ›´æ­£â€å…¥å£ï¼ˆä¸‹æ‹‰é€‰æ‹© -7..+7ï¼‰

### fifths åˆ°ï¼ˆå¤§è°ƒ/å°è°ƒï¼‰æ˜ å°„è¡¨ï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰

* -7ï¼šCb / Abm
* -6ï¼šGb / Ebm
* -5ï¼šDb / Bbm
* -4ï¼šAb / Fm
* -3ï¼šEb / Cm
* -2ï¼šBb / Gm
* -1ï¼šF / Dm
* 0ï¼šC / Am
* +1ï¼šG / Em
* +2ï¼šD / Bm
* +3ï¼šA / F#m
* +4ï¼šE / C#m
* +5ï¼šB / G#m
* +6ï¼šF# / D#m
* +7ï¼šC# / A#m

---

## 5.3 éŸ³ç¬¦äº‹ä»¶æŠ½å–ï¼ˆå¼ºçƒˆæ¨èï¼šç”¨ OSMD çš„æ—¶é—´æˆ³ APIï¼Œçœå‘½ï¼‰

OSMD å®˜æ–¹ Wiki ç»™äº†â€œæå–éŸ³ç¬¦æ—¶é—´æˆ³â€çš„åšæ³•ï¼šé€šè¿‡ Cursor çš„ Iteratorï¼ˆMusicPartManagerIteratorï¼‰æ‹¿åˆ°æ¯ä¸ªä½ç½®çš„å½“å‰æ—¶é—´æˆ³ï¼Œå†æŠŠå½“å‰ voice entries çš„ notes æ‹‰å‡ºæ¥ï¼Œå¾—åˆ°éŸ³ç¬¦ä¸æ—¶é—´ã€‚([GitHub][9])

**MVP äº‹ä»¶ç»“æ„ï¼ˆå‰ç«¯ç»ƒä¹ å¼•æ“ç”¨ï¼‰**

```ts
type PracticeEvent = {
  idx: number;
  onsetSec: number;       // æœŸæœ›æŒ‰ä¸‹æ—¶é—´ï¼ˆç§’ï¼‰
  durSec: number;         // æœŸæœ›æŒ‰ä½æ—¶é•¿ï¼ˆç§’ï¼‰
  isRest: boolean;        // æ˜¯å¦ä¼‘æ­¢
  midi?: number;          // ç›®æ ‡éŸ³é«˜ï¼ˆè¯†è°±æ¨¡å¼ç”¨ï¼‰
  staff?: "treble" | "bass";
  measureIndex?: number;
  chordGroupId?: number;  // åŒä¸€æ—¶é—´æˆ³çš„å’Œå¼¦å¯åŒç»„
};
```

**OSMD æŠ½å–ç­–ç•¥ï¼ˆMVP ç®€åŒ–ç‰ˆï¼‰**

* ç”¨ iterator éå†æ•´é¦–ï¼ˆæˆ–é€‰å®šèŒƒå›´ï¼‰
* æ¯ä¸ª cursor ä½ç½®ï¼š

  * å–å½“å‰ `CurrentVoiceEntries`
  * å¯¹æ¯ä¸ª voice entryï¼š

    * å¯¹æ¯ä¸ª noteï¼š

      * è‹¥æ˜¯ restï¼šç”Ÿæˆ `isRest=true`
      * è‹¥æ˜¯éŸ³ï¼šç”Ÿæˆ `midi`ï¼ˆå¯ç”¨ OSMD çš„ `halfTone + 12` æ–¹å¼ï¼ŒWiki ç¤ºä¾‹è¿™ä¹ˆåšï¼‰([GitHub][9])
  * æŠŠ `iterator.currentTimeStamp.realValue` è½¬æˆç§’ï¼ˆä¹˜ç³»æ•°ä¸ BPMï¼‰

**æ—¶é—´æˆ³è½¬ç§’ï¼ˆç»Ÿä¸€è§„åˆ™ï¼‰**

* è®¾ç”¨æˆ· BPMï¼ˆé»˜è®¤ 80ï¼Œå¯è°ƒï¼‰
* OSMD çš„ realValue åœ¨ Wiki é‡Œç”¨æ³•ï¼š`timeSec = timeStampRealValue * 4 * (60 / bpm)` ([GitHub][9])
* æ—¶å€¼åŒç†ï¼š`durSec = note.Length.RealValue * 4 * (60 / bpm)` ([GitHub][9])

> å¥½å¤„ï¼šä¸ç®¡ 4/4ã€3/8ã€2/2ï¼ŒOSMD/iterator çš„æ—¶é—´æˆ³ä½“ç³»éƒ½èƒ½ç”¨åŒä¸€å¥—æ¢ç®—æ–¹å¼ã€‚([GitHub][9])

---

## 5.4 èŠ‚å¥è®­ç»ƒï¼šä»è°±å­äº‹ä»¶æ˜ å°„åˆ° 1 é”®/2 é”®

è¾“å…¥ï¼š`PracticeEvent[]`ï¼ˆåŒ…å« onsetSec/durSec/isRestï¼‰

è¾“å‡ºï¼š`RhythmDrillEvent[]`

```ts
type RhythmDrillEvent = {
  idx: number;
  onsetSec: number;
  durSec: number;
  isRest: boolean;
  targetMidi: number;  // 1é”®/2é”®æ˜ å°„ç»“æœï¼ˆæ¯”å¦‚ C4=60, D4=62ï¼‰
};
```

æ˜ å°„è§„åˆ™ï¼š

* 1 é”®ï¼šæ‰€æœ‰ `!isRest` â†’ targetMidi = 60
* 2 é”®ï¼šæŒ‰å‡ºç°é¡ºåºäº¤æ›¿åˆ†é…ï¼š60, 62, 60, 62...
* ä¼‘æ­¢ï¼štargetMidi ç•™ç©ºæˆ–è®¾ä¸º nullï¼ˆä¸å…è®¸æŒ‰ï¼‰

---

## 5.5 è®¡åˆ†è§„åˆ™ï¼ˆæ–°æ‰‹æ¨¡å¼ vs æ™®é€šæ¨¡å¼ï¼‰

**æ ¸å¿ƒï¼šæŠŠâ€œæŒ‰ä¸‹æ—¶åˆ»â€å’Œâ€œæ¾å¼€æ—¶åˆ»â€ä¸æœŸæœ›æ—¶é—´å¯¹é½æ¯”è¾ƒã€‚**

### è¯„åˆ†å‚æ•°ï¼ˆå¯è°ƒï¼ŒMVP ç»™é»˜è®¤å€¼ï¼‰

* `onsetToleranceMs = max(80ms, 0.12 * durSec * 1000)`
* `holdToleranceMs  = max(120ms, 0.18 * durSec * 1000)`
* `earlyLatePenalty`: è¶…å‡ºå®¹å¿çª—å£åçº¿æ€§æ‰£åˆ†
* `restPenalty`: ä¼‘æ­¢æœŸé—´å¦‚æœæŒ‰ä¸‹ï¼Œæ‰£å›ºå®šåˆ†ï¼ˆMVP å¯å…ˆå…³é—­ï¼‰

### å•äº‹ä»¶è¯„åˆ†ï¼ˆå»ºè®® 100 åˆ†åˆ¶æ‹†åˆ†ï¼‰

* Onsetï¼š0..60 åˆ†
* Holdï¼š0..40 åˆ†
* è¿å‡»ï¼šè¿ç»­ â‰¥ N ä¸ªäº‹ä»¶è¾¾æ ‡ï¼Œé¢å¤–åŠ æˆ

### ä¸¤ç§æ¨¡å¼å·®å¼‚

* æ–°æ‰‹æ¨¡å¼ï¼š

  * UI æ˜¾ç¤º `durSec` å¯¹åº”çš„â€œæ‹æ•°â€ï¼ˆä¾‹å¦‚ 1 æ‹ã€0.5 æ‹ï¼‰
  * æ˜¾ç¤º hold è¿›åº¦æ¡ï¼ˆæŒ‰ä½æ—¶å¡«å……ï¼‰
  * å…è®¸æ›´å®½å®¹çš„å®¹é”™ï¼ˆæ¯”å¦‚ tolerance * 1.25ï¼‰
* æ™®é€šæ¨¡å¼ï¼š

  * ä¸æ˜¾ç¤ºæ‹æ•°ä¸ hold æç¤º
  * å®¹é”™æ”¶ç´§ï¼ˆtolerance * 1.0ï¼‰

---

## 6. äº¤äº’ä¸é¡µé¢è®¾è®¡ï¼ˆæŒ‰â€œä½ ä¼šæ€ä¹ˆç”¨â€æ¥ç”»æµç¨‹ï¼‰

## 6.1 é¡µé¢ä¸€ï¼šè°±é¢å¯¼å…¥

* ä¸Šä¼ æŒ‰é’®ï¼šé€‰æ‹©å›¾ç‰‡ï¼ˆç›¸å†Œ/æ–‡ä»¶ï¼‰
* é¢„è§ˆç¼©ç•¥å›¾
* è¯†åˆ«æŒ‰é’®ï¼šå¼€å§‹è¯†åˆ«ï¼ˆæ˜¾ç¤ºè¿›åº¦ï¼‰
* è¯†åˆ«å®Œæˆï¼šè¿›å…¥â€œè°±é¢è¯¦æƒ…é¡µâ€

é”™è¯¯å¤„ç†ï¼š

* OMR å¤±è´¥ï¼šæç¤ºâ€œå›¾åƒå¯èƒ½è¿‡æš—/æ­ªæ–œ/åˆ†è¾¨ç‡ä½â€ï¼Œå»ºè®®æ¢æ›´æ¸…æ™°å›¾

## 6.2 é¡µé¢äºŒï¼šè°±é¢è¯¦æƒ…ï¼ˆè¯†åˆ«ç»“æœï¼‰

* é¡¶éƒ¨ä¿¡æ¯å¡ï¼š

  * è°ƒå·ï¼šâ™­â™­ / ##ï¼ˆå¹¶æ˜¾ç¤ºå¯èƒ½çš„å¤§/å°è°ƒï¼‰
  * æ‹å·ï¼š4/4ã€3/8...
  * BPMï¼šé»˜è®¤ 80ï¼ˆå¯è°ƒï¼‰
* ä¸»åŒºåŸŸï¼šOSMD æ¸²æŸ“çš„è°±é¢
* æŒ‰é’®ï¼š

  * å¼€å§‹è¯†è°±ç»ƒä¹ 
  * å¼€å§‹èŠ‚å¥ç»ƒä¹ ï¼ˆ1é”®/2é”®ï¼‰
  * æ‰‹åŠ¨ä¿®æ­£ï¼ˆè°ƒå·/æ‹å·/BPMï¼‰

## 6.3 é¡µé¢ä¸‰ï¼šè¯†è°±ç»ƒä¹ ï¼ˆå¯¹åº”ç´é”®ï¼‰

å¸ƒå±€ï¼š

* ä¸Šï¼šè°±é¢ï¼ˆOSMDï¼‰ï¼ŒCursor é«˜äº®å½“å‰éŸ³ç¬¦/å’Œå¼¦
* ä¸­ï¼šæç¤ºåŒºï¼ˆæ–°æ‰‹æ¨¡å¼å¯æ˜¾ç¤ºéŸ³åï¼Œä¾‹å¦‚ â€œF#4â€ï¼‰
* ä¸‹ï¼šé’¢ç´é”®ç›˜ï¼ˆå¯æ»šåŠ¨åˆ°ç›®æ ‡åŒºåŸŸï¼‰ï¼Œé«˜äº®ç›®æ ‡é”®

æµç¨‹ï¼š

1. é€‰æ‹©è¾“å…¥æ–¹å¼ï¼šå±å¹•é”®ç›˜ / MIDI
2. é€‰æ‹©æ¨¡å¼ï¼šæ–°æ‰‹/æ™®é€š
3. å¼€å§‹ï¼šcursor æŒ‡å‘ç¬¬ä¸€ä¸ªäº‹ä»¶
4. ç”¨æˆ·æŒ‰å¯¹éŸ³é«˜ï¼š

   * å¾—åˆ† + cursor.next()
5. æŒ‰é”™ï¼š

   * æ‰£åˆ† + éœ‡åŠ¨/æç¤ºï¼ˆç§»åŠ¨ç«¯å¯åŠ è½»åé¦ˆï¼‰

> OSMD Cursor æ˜¯ç°æˆçš„ï¼Œèƒ½è·Ÿéšä¸é«˜äº®ã€‚([OpenSheetMusicDisplay][10])

## 6.4 é¡µé¢å››ï¼šèŠ‚å¥ç»ƒä¹ ï¼ˆä½ æœ€æƒ³è¦çš„â€œæŒ‰å¤šä¹…â€ï¼‰

å¸ƒå±€ï¼š

* ä¸Šï¼šèŠ‚æ‹å™¨ï¼ˆé—ªçƒ + click å£°ï¼‰
* ä¸­ï¼šèŠ‚å¥å¡ç‰‡ï¼ˆæ˜¾ç¤ºå½“å‰éŸ³ç¬¦/ä¼‘æ­¢ç¬¦ï¼‰
* ä¸‹ï¼š1é”®/2é”®å¤§æŒ‰é’®ï¼ˆä¹Ÿå¯æ˜¾ç¤ºå°é’¢ç´ï¼‰

æ–°æ‰‹æ¨¡å¼é¢å¤–ï¼š

* æ˜¾ç¤ºâ€œæŒ‰ä½è¿›åº¦æ¡â€
* æ˜¾ç¤ºâ€œè¿˜éœ€æŒ‰ä½ XX msâ€
* ä¼‘æ­¢æ—¶æ˜¾ç¤ºâ€œåœâ€å¹¶å€’è®¡æ—¶ï¼ˆå¯é€‰ï¼‰

æ™®é€šæ¨¡å¼ï¼š

* åªç»™èŠ‚æ‹å™¨ä¸èŠ‚å¥å¡ç‰‡ï¼Œä¸æç¤ºæŒ‰å¤šä¹…

---

## 7. åç«¯ OMR æœåŠ¡è®¾è®¡ï¼ˆCodex å¯ç›´æ¥ç…§ç€å†™ï¼‰

## 7.1 API çº¦å®šï¼ˆHTTPï¼ŒJSONï¼‰

### POST `/api/omr/scan`

* Content-Type: `multipart/form-data`
* å­—æ®µï¼š

  * `images[]`: æ–‡ä»¶ï¼ˆ1..Nï¼‰ï¼ŒMVP å…ˆç”¨ 1
  * `name`ï¼ˆå¯é€‰ï¼‰ï¼šè°±é¢åç§°
* è¿”å›ï¼š

```json
{
  "pieceId": "uuid",
  "pages": [
    {
      "pageId": "uuid",
      "musicxml": "<score-partwise>...</score-partwise>",
      "meta": {
        "fifths": -2,
        "time": { "beats": "4", "beatType": "4" }
      }
    }
  ]
}
```

### GET `/api/pieces/:pieceId`

* è¿”å›åŒä¸Šï¼ˆç”¨äºåˆ·æ–°/æ¢å¤ï¼‰

## 7.2 è°ƒç”¨ Audiveris çš„æ–¹å¼ï¼ˆå‘½ä»¤è¡Œæ‰¹å¤„ç†ï¼‰

Audiveris CLI è¯­æ³•ï¼ˆå…³é”®ç‚¹ï¼‰ï¼š

* `-batch`ï¼šæ—  GUI æ¨¡å¼
* `-export`ï¼šå¯¼å‡º MusicXML
* `-output <dir>`ï¼šè¾“å‡ºç›®å½•
* `audiveris [OPTIONS] [--] [INPUT_FILES]` çš„ `--` å¯ç”¨æ¥åˆ†éš”å‚æ•°ä¸è¾“å…¥æ–‡ä»¶([Bacchus HLG][3])

**å»ºè®®çš„è°ƒç”¨æ¨¡æ¿ï¼ˆMVPï¼‰**

* `audiveris -batch -export -output <outDir> -- <imagePath>`

> ä½ çš„å®ç°è¦åšä¸¤ä»¶äº‹ï¼š
>
> 1. æ‰¾åˆ°å¯¼å‡ºçš„ `.mxl` æ–‡ä»¶ï¼ˆå‹ç¼©çš„ MusicXMLï¼‰
> 2. è§£å‹æ‹¿åˆ° `.xml` æ–‡æœ¬åè¿”å›ç»™å‰ç«¯

Audiveris æœ¬èº«æ”¯æŒå¯¼å‡º MusicXMLï¼Œä¸”é¡¹ç›®è¯´æ˜ä¸­æ˜ç¡®æåˆ°å¯¼å‡º MusicXML 4.0ã€‚([GitHub][5])

## 7.3 è¿è¡Œä¸éƒ¨ç½²ï¼ˆæœ€çœå¿ƒï¼šDocker Composeï¼‰

æä¾›ï¼š

* `docker-compose.yml`

  * `api`ï¼šNode + Audiverisï¼ˆé€šè¿‡å®‰è£…åŒ…æˆ–é¢„è£…æ–¹å¼ï¼‰
  * `web`ï¼šVite build åé™æ€ç«™ç‚¹

Audiveris å®˜æ–¹æä¾›å„ OS å®‰è£…åŒ…ï¼ˆWindows .msiï¼ŒLinux .debï¼ŒmacOS .dmgï¼‰ï¼Œå¹¶ä¸”è‡ªå¸¦ JRE çš„å®‰è£…æ–¹å¼ä» 5.5 èµ·å°±æœ‰è¯´æ˜ã€‚([Audiveris][11])

> å®æ“å»ºè®®ï¼šapi å®¹å™¨ç”¨ Ubuntu baseï¼Œä¸‹è½½å¯¹åº”ç‰ˆæœ¬ `.deb` å®‰è£…ï¼Œç„¶åç›´æ¥è°ƒç”¨ `audiveris`/`Audiveris` å‘½ä»¤ã€‚
> å¦‚æœä½ ä¸æƒ³åœ¨å®¹å™¨é‡Œè£…ï¼šä¹Ÿå¯è®©ç”¨æˆ·æœ¬æœºè£… Audiverisï¼Œç„¶ååœ¨ `.env` é… `AUDIVERIS_BIN=/path/to/audiveris`ã€‚

---

## 8. å‰ç«¯ç»ƒä¹ å¼•æ“å®ç°è¦ç‚¹ï¼ˆCodex ç›´å†™æ¸…å•ï¼‰

## 8.1 è¾“å…¥å±‚ï¼ˆInput Adapterï¼‰

ç»Ÿä¸€æˆäº‹ä»¶æµï¼š

```ts
type NoteInputEvent = {
  midi: number;
  type: "down" | "up";
  t: number; // performance.now() æˆ– AudioContext.currentTime
};
```

### å±å¹•é”®ç›˜

* pointerdown â†’ down
* pointerup/pointercancel â†’ up

### Web MIDI

* ä½¿ç”¨ `navigator.requestMIDIAccess()`
* ç›‘å¬ `onmidimessage`
* è§£æ NoteOn/NoteOff
* å‘é€åˆ°ç»Ÿä¸€äº‹ä»¶æµ

> Web MIDI API çš„ `MIDIOutput.send()` / MIDI æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶è§ MDNã€‚([MDN Web Docs][4])

## 8.2 ç»ƒä¹ å±‚ï¼ˆPractice Engineï¼‰

è¾“å…¥ï¼š

* `PracticeEvent[]`
* `NoteInputEvent` æµ

è¾“å‡ºï¼š

* å½“å‰ idx
* scoreã€comboã€æ¯ä¸ªäº‹ä»¶çš„åˆ¤å®šï¼ˆPerfect/Good/Missï¼‰

åˆ¤å®šé€»è¾‘ï¼ˆèŠ‚å¥è®­ç»ƒæ ¸å¿ƒï¼‰ï¼š

* å¯¹æ¯ä¸ªç›®æ ‡äº‹ä»¶ iï¼š

  * ç­‰å¾…æŒ‰ä¸‹ï¼ˆdownï¼‰
  * è®°å½• `downTime`
  * ç­‰å¾…æ¾å¼€ï¼ˆupï¼‰
  * è®°å½• `upTime`
  * è®¡ç®—ï¼š

    * onsetDelta = downTime - (startTime + onsetSec)
    * holdDelta  = (upTime - downTime) - durSec
  * æ‰“åˆ†å¹¶è¿›å…¥ä¸‹ä¸€äº‹ä»¶

## 8.3 æ¸²æŸ“å±‚ï¼ˆOSMDï¼‰

* åŠ è½½ `musicxml` å­—ç¬¦ä¸²ï¼š`osmd.load(xmlString)` ç„¶å `osmd.render()` ([OpenSheetMusicDisplay][12])
* å¯ç”¨ cursorï¼š

  * `osmd.enableOrDisableCursors(true)`
  * `osmd.cursor.show()`
  * æ¯è¿‡ä¸€é¢˜ï¼š`osmd.cursor.next()`ï¼ˆè¯†è°±æ¨¡å¼ï¼‰
* é«˜äº®å½“å‰å°èŠ‚ï¼ˆå¯é€‰ç¬¬äºŒå…‰æ ‡ï¼ŒOSMD wiki demo æœ‰ç¤ºä¾‹ï¼‰([GitHub][13])

---

## 9. å·¥ç¨‹ç»“æ„ï¼ˆMonorepoï¼ŒCodex ç”Ÿæˆæœ€é¡ºï¼‰

```
piano-sightread-app/
  apps/
    web/                 # React + Vite + PWA + OSMD
    api/                 # Node + Express + OMR bridge
  packages/
    shared/              # typesã€è¯„åˆ†å‡½æ•°ã€å·¥å…·
  docker-compose.yml
  README.md
```

### apps/api å…³é”®æ–‡ä»¶

* `src/server.ts`ï¼šExpress å¯åŠ¨
* `src/routes/omr.ts`ï¼š/api/omr/scan
* `src/services/audiveris.ts`ï¼šspawn è°ƒç”¨ + è¾“å‡ºæ–‡ä»¶æ”¶é›†
* `src/services/mxl.ts`ï¼šè§£å‹ .mxl â†’ xml string
* `src/services/meta.ts`ï¼šä» xml æå– fifthsã€beatsã€beat-type

### apps/web å…³é”®æ–‡ä»¶

* `src/pages/ImportPage.tsx`
* `src/pages/PiecePage.tsx`ï¼ˆOSMD æ¸²æŸ“ + æ¨¡å¼é€‰æ‹©ï¼‰
* `src/pages/PracticeSightRead.tsx`
* `src/pages/PracticeRhythm.tsx`
* `src/components/PianoKeyboard.tsx`
* `src/engine/practiceEngine.ts`
* `src/input/midiAdapter.ts`
* `src/input/onScreenAdapter.ts`

---

## 10. æµ‹è¯•è®¡åˆ’ï¼ˆMVP å¿…åšï¼Œé¿å…â€œçœ‹èµ·æ¥èƒ½è·‘ï¼Œå®é™…å…¨æ¼æ‹â€ï¼‰

* å•å…ƒæµ‹è¯•ï¼ˆpackages/sharedï¼‰ï¼š

  * æ—¶é—´å®¹é”™åˆ¤å®š
  * æ‰“åˆ†å‡½æ•°
  * è¿å‡»/æ‰£åˆ†è¾¹ç•Œ
* é›†æˆæµ‹è¯•ï¼ˆapiï¼‰ï¼š

  * ç»™ä¸€å¼ å›ºå®šæµ‹è¯•è°±å›¾ï¼Œç¡®ä¿èƒ½äº§å‡º xmlï¼ˆCI å¯è·³è¿‡ï¼Œè‡³å°‘æœ¬åœ°å¯è·‘ï¼‰
* ç«¯åˆ°ç«¯ï¼ˆwebï¼‰ï¼š

  * ç”¨å±å¹•é”®ç›˜å®Œæˆä¸€æ®µèŠ‚å¥ç»ƒä¹ ï¼Œå¾—åˆ†ä¸åˆ¤å®šç¨³å®š

---

## 11. é£é™©ä¸å¯¹ç­–ï¼ˆæå‰æŠŠå‘å†™åœ¨çº¸ä¸Šï¼‰

1. **OMR å‡†ç¡®ç‡ä¸å¯èƒ½ 100%**ï¼ˆå°¤å…¶å›¾ç‰‡æ­ªã€ç³Šã€é˜´å½±ï¼‰

   * å¯¹ç­–ï¼šå…è®¸æ‰‹åŠ¨æ”¹è°ƒå·/æ‹å·/BPMï¼›å…è®¸é‡æ–°è¯†åˆ«ï¼›ç»™â€œæ‹ç…§å»ºè®®â€æç¤ºã€‚
2. **Audiveris è¿è¡Œè€—æ—¶**

   * å¯¹ç­–ï¼šåšç¼“å­˜ï¼ˆåŒä¸€å¼ å›¾ hash ç›¸åŒåˆ™ç›´æ¥è¯»ä¸Šæ¬¡ xmlï¼‰ï¼›æ˜¾ç¤ºè¿›åº¦æ¡ã€‚
3. **Web MIDI å…¼å®¹æ€§**

   * å¯¹ç­–ï¼šæ°¸è¿œä¿ç•™å±å¹•é”®ç›˜è¾“å…¥ï¼›æç¤ºâ€œå¤–æ¥ MIDI å»ºè®®ç”¨ Chrome/Edgeâ€ã€‚
4. **è®¸å¯è¯**ï¼šAudiveris æ˜¯ AGPL-3.0

   * å¯¹ç­–ï¼šå¦‚æœä½ æœªæ¥è¦é—­æºå•†ç”¨ï¼Œè¦ä¹ˆå¼€æºæ•´ä¸ªè”åŠ¨æœåŠ¡ç«¯ï¼Œè¦ä¹ˆæ¢å•†ä¸š OMR æ–¹æ¡ˆã€‚([GitHub][5])

---

## 12. é‡Œç¨‹ç¢‘æ‹†åˆ†ï¼ˆæŒ‰â€œæœ€çŸ­å¯ç”¨è·¯å¾„â€ï¼‰

* M0ï¼ˆ1-2 å¤©ï¼‰ï¼šå·¥ç¨‹éª¨æ¶ + Import é¡µé¢ + api ä¸Šä¼ æ¥å£
* M1ï¼šAudiveris è·‘é€šï¼Œè¿”å› MusicXMLï¼ŒOSMD èƒ½æ¸²æŸ“
* M2ï¼šè¯†è°±ç»ƒä¹ ï¼ˆå±å¹•é”®ç›˜ï¼‰+ cursor.next() é—¯å…³
* M3ï¼šèŠ‚å¥ç»ƒä¹ ï¼ˆ1 é”®ï¼‰+ æ–°æ‰‹æ¨¡å¼æŒ‰ä½æç¤º + è®¡åˆ†
* M4ï¼šèŠ‚å¥ç»ƒä¹ ï¼ˆ2 é”®ï¼‰+ æ™®é€šæ¨¡å¼ + ç»Ÿè®¡é¡µ
* M5ï¼šWeb MIDI æ¥å…¥ + æœ¬åœ°ç¼“å­˜ + å°ä¿®å°è¡¥

---

# é™„å½• Aï¼šç»™ Codex çš„â€œæ‰§è¡Œè¯´æ˜ä¹¦â€ï¼ˆå¯ç›´æ¥å¤åˆ¶ç²˜è´´å½“æ€»æç¤ºè¯ï¼‰

ä¸‹é¢è¿™æ®µä½ å¯ä»¥ç›´æ¥ä¸¢ç»™ Codexï¼Œå½“ä½œâ€œå…¨é¡¹ç›®ç”ŸæˆæŒ‡ä»¤â€ã€‚

```text
ä½ è¦ç”Ÿæˆä¸€ä¸ªå¯è¿è¡Œçš„ monorepo é¡¹ç›®ï¼špiano-sightread-app/
ç›®æ ‡ï¼šä¸Šä¼ é’¢ç´è°±å›¾ç‰‡ -> åç«¯è°ƒç”¨ Audiveris OMR -> è¿”å› MusicXML -> å‰ç«¯ç”¨ OpenSheetMusicDisplay(OSMD) æ¸²æŸ“ï¼Œå¹¶æä¾›ä¸¤ç§ç»ƒä¹ ï¼šè¯†è°±ç»ƒä¹ ï¼ˆæŒ‰å¯¹éŸ³é«˜è¿›å…¥ä¸‹ä¸€éŸ³ï¼Œæ”¯æŒå±å¹•é”®ç›˜ä¸ WebMIDIï¼‰ï¼›èŠ‚å¥ç»ƒä¹ ï¼ˆæŠŠè°±å­èŠ‚å¥æ˜ å°„åˆ°1é”®æˆ–2é”®ï¼Œå«æ–°æ‰‹æ¨¡å¼æç¤ºæŒ‰å¤šä¹…ä¸æ™®é€šæ¨¡å¼ä¸æç¤ºï¼Œå¸¦è®¡åˆ†ï¼‰ã€‚

æŠ€æœ¯æ ˆï¼š
- å‰ç«¯ï¼šReact + TypeScript + Vite + OSMD
- åç«¯ï¼šNode.js + TypeScript + Express + multer
- OMRï¼šè°ƒç”¨ Audiveris CLIï¼ˆ-batch -export -output -- inputImageï¼‰
- å°† Audiveris è¾“å‡ºçš„ .mxl è§£å‹ä¸º .xml å­—ç¬¦ä¸²è¿”å›ç»™å‰ç«¯
- ä» MusicXML æå– metaï¼šfifthsï¼ˆè°ƒå·å‡é™å·æ•°ï¼‰ã€beats/beat-typeï¼ˆæ‹å·ï¼‰
- èŠ‚å¥äº‹ä»¶æŠ½å–å»ºè®®ç”¨ OSMD Wiki çš„ Iterator æ—¶é—´æˆ³æ–¹æ³•ï¼ˆMusicPartManagerIteratorï¼‰ï¼Œç”Ÿæˆ PracticeEvent[]ï¼šonsetSecã€durSecã€isRestã€midi(ç”¨ note.halfTone + 12)
- è®¡åˆ†ï¼šonset ä¸ hold ä¸¤æ®µè¯„åˆ†ï¼›æ–°æ‰‹æ¨¡å¼æ˜¾ç¤ºæŒ‰ä½è¿›åº¦æ¡ä¸æ—¶å€¼æç¤ºï¼›æ™®é€šæ¨¡å¼ä¸æ˜¾ç¤ºæ—¶å€¼æç¤º

å¿…é¡»äº¤ä»˜ï¼š
1) docker-compose.ymlï¼ˆè‡³å°‘èƒ½å¯åŠ¨ web + apiï¼›Audiveris å¯é€šè¿‡å¤–éƒ¨å®‰è£…è·¯å¾„æˆ–å®¹å™¨å®‰è£…ï¼‰
2) apps/apiï¼š/api/omr/scan å¯ç”¨ï¼Œè¿”å› {pieceId, pages:[{musicxml, meta}]}
3) apps/webï¼šImport -> Piece -> PracticeSightRead -> PracticeRhythm é¡µé¢é—­ç¯
4) å±å¹•é”®ç›˜è¾“å…¥å¯å®Œæ•´ç»ƒå®Œä¸€æ®µï¼›WebMIDI ä½œä¸ºå¯é€‰å¢å¼º
5) READMEï¼šæœ¬åœ°å¼€å‘ä¸éƒ¨ç½²è¯´æ˜ï¼ŒåŒ…å« AUDIVERIS_BIN é…ç½®æ–¹å¼

æ³¨æ„ï¼š
- ä¸è¦ä½¿ç”¨è¿‡é‡çš„çŠ¶æ€ç®¡ç†
- ä»£ç è¦æœ‰ç±»å‹ã€é”™è¯¯å¤„ç†ã€è¾¹ç•Œå¤„ç†
- æä¾›ä¸€äº›ç¤ºä¾‹å‡æ•°æ®ä¸â€œæ²¡æœ‰ Audiveris æ—¶çš„ mock æ¨¡å¼â€ï¼Œè®©å‰ç«¯ä¹Ÿèƒ½è·‘
```

---

å¦‚æœä½ æ„¿æ„å†â€œç®€å•ä½†æ›´é¡ºæ‰‹â€ä¸€ç‚¹ï¼Œæˆ‘å»ºè®®ä½ åœ¨èŠ‚å¥ç»ƒä¹ é¡µåŠ ä¸€ä¸ªå°å¼€å…³ï¼š**â€œåªç»ƒå³æ‰‹ï¼ˆé«˜éŸ³è°±è¡¨ï¼‰/åªç»ƒå·¦æ‰‹ï¼ˆä½éŸ³è°±è¡¨ï¼‰/ä¸¤æ‰‹ä¸€èµ·â€**ã€‚å®ç°ä¸Šåªæ˜¯è¿‡æ»¤ OSMD iterator çš„ voice entriesï¼ŒUI ä½“éªŒå´ä¼šåƒå¤šé€äº†ä¸€æŠŠé’¥åŒ™ ğŸ”‘ã€‚

[1]: https://audiveris.github.io/audiveris/_pages/handbook/?utm_source=chatgpt.com "Audiveris Handbook"
[2]: https://opensheetmusicdisplay.org/?utm_source=chatgpt.com "Open Sheet Music Display: Home"
[3]: https://bacchushlg.gitbooks.io/audiveris-5-1/content/advanced/cli.html "Command Line Interface Â· Audiveris 5.1"
[4]: https://developer.mozilla.org/en-US/docs/Web/API/MIDIOutput/send?utm_source=chatgpt.com "MIDIOutput: send() method - Web APIs - MDN Web Docs"
[5]: https://github.com/Audiveris/audiveris/tree/5.9.0 "GitHub - Audiveris/audiveris at 5.9.0"
[6]: https://usermanuals.musicxml.com/MusicXML/Content/ST-MusicXML-fifths.htm?utm_source=chatgpt.com "Simple Type: fifths"
[7]: https://www.musicxml.com/publications/makemusic-recordare/xml-2001/elements-of-musicxml-design/?utm_source=chatgpt.com "Elements of MusicXML Design"
[8]: https://www.w3.org/2021/06/musicxml40/musicxml-reference/elements/duration/?utm_source=chatgpt.com "The <duration> element | MusicXML 4.0"
[9]: https://github.com/opensheetmusicdisplay/opensheetmusicdisplay/wiki/Tutorial---Extracting-note-timing-for-playing "Tutorial   Extracting note timing for playing Â· opensheetmusicdisplay/opensheetmusicdisplay Wiki Â· GitHub"
[10]: https://opensheetmusicdisplay.github.io/classdoc/classes/Cursor.html?utm_source=chatgpt.com "Cursor | OpenSheetMusicDisplay"
[11]: https://audiveris.github.io/audiveris/_pages/tutorials/install/binaries/?utm_source=chatgpt.com "Installing binaries | Audiveris Pages"
[12]: https://opensheetmusicdisplay.github.io/classdoc/classes/OpenSheetMusicDisplay.html?utm_source=chatgpt.com "Class OpenSheetMusicDisplay"
[13]: https://github.com/opensheetmusicdisplay/opensheetmusicdisplay/wiki/Exploring-the-Demo?utm_source=chatgpt.com "Exploring the Demo Â· opensheetmusicdisplay ..."
